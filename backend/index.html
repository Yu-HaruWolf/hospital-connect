<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>rescue</title>
<style>
  body{
    text-align: center;
  }
</style>
</head>

<body>
  <div>
    <button id="dep00">内科</button>
    <button id="dep01">小児科</button>
    <button id="dep02">皮膚科</button>
    <button id="dep03">精神科</button>
    <button id="dep04">外科</button>
    <button id="dep05">産婦人科</button>
    <button id="dep06">眼科</button><br>
    <button id="dep07">耳鼻咽喉科</button>
    <button id="dep08">泌尿器科</button>
    <button id="dep09">脳神経外科</button>
    <button id="dep10">形成外科</button>
    <button id="dep11">整形外科</button><br><br>
    <button id="serchAnd">AND検索</button><br><br>
    <button id="serchOr">OR検索</button><br><br>
    <button id="submit">登録</button>
  </div>
  <br>
  <!--病院受け入れ人数更新-->
  <div>
    <textarea id="hospitalName" cols="30" rows="1" placeholder="病院名"></textarea>
    <textarea id="numOfAcceptedID" cols="5" rows="1" placeholder="人数"></textarea>

    <button id="update">更新</button>
  </div>

 <!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- JQuery -->


<!--** 以下Firebase **-->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js';
  import { getFirestore,collection, addDoc,getDoc,getDocs,query, where,GeoPoint,doc, updateDoc} from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js';
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
  
  // Your web app's Firebase configuration
  const firebaseConfig = {
      apiKey: "AIzaSyCAXeaS9p1P4gnyywlx4E20zoO6jxjaeWs",
      authDomain: "tcu-rescue.firebaseapp.com",
      projectId: "tcu-rescue",
      storageBucket: "tcu-rescue.appspot.com",
      messagingSenderId: "246901411650",
      appId: "1:246901411650:web:86d48bc20cb31ba88682db"
    };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig); //firebaseにアクセス
  const db = getFirestore(app);  //データベースにアクセス
  const requestRef = collection(db, "request");
  console.log(requestRef);

  //内科ボタンを押すと実行
  //requestの直下にドキュメントとフィールドが自動生成される
  $("#dep00").on("click",async function() {
    const a =  await addDoc(requestRef,{
      patient : '0',
      ambulance : '0616',
      status : 'progress'
    });

    const recDoc = await a.path;
    console.log(recDoc);

  });
  
  //以下AND検索とOR検索に関する機能
  const hospitalArray = ['department.0', 'department.1','department.2']//仮に与えられたとする

  //hospitalArrayの情報とすべて当てはまる病院を表示(AND検索)
  $("#serchAnd").on("click",async function(){
    const hospitalRef = collection(db, "hospital");
    
    //hospitalArray[0]がtrueとなるクエリを作成
    let queryAnd = query(hospitalRef, where(hospitalArray[0], "==", true));
    for ( var i = 1; i < hospitalArray.length; i++ ){
      queryAnd = query(queryAnd, where(hospitalArray[i], "==", true))
    };

    const querySnapshot = await getDocs(queryAnd);
    querySnapshot.forEach((doc) => { // 病院の情報を取得 & consoleに表示
      console.log(doc.id, " => ", doc.data());
      console.log(doc.data().name)//フィールド取得
    });
  });

    //hospitalArrayの情報とひとつでも当てはまる病院を表示(OR検索)
  $("#serchOr").on("click",async function(){
    const hospitalRef = collection(db, "hospital");
    let hospitalName = {} //空の辞書作成
    for ( var i = 0; i < hospitalArray.length; i++ ){
      var q = query(hospitalRef, where(hospitalArray[i], "==", true));
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach((doc) => {
        hospitalName[doc.data().name] = doc.data() // keyが重複した場合、後に追加したデータが優先される
      });
    };
    console.log(hospitalName)
    console.log(hospitalName['高須クリニック0'])
  });
  
  
  
  //病院のデータベース
  const hospitalData = {
    ID : '0000',
    address : 'japana',
    call : '08012345678',
    name : '高須クリニック012',
    place: new GeoPoint(35.6895, 139.6917),
    department: {
        0: false,
        1: false,
        2: false,
        3: false,
        4: false,
        5: false,
        6: false,
        7: false,
        8: false,
        9: false,
        10: false,
        11: false
    },
    numOfAccepted : 10
  };

  //病院を新規に登録
  $("#submit").on("click",async function() {
    await addDoc(collection(db,"hospital"),hospitalData)
      .then(() => {
        console.log("Document successfully written!");
      })
      .catch((error) => {
        console.error("Error writing doccument :",error);
      });
  });
  //病院に通知
  const hospitalName = "AAA"


  $("#update").on("click",async function(){
    //病院名検索
    const hospitalRef = collection(db, "hospital");
    const serchHospital = document.getElementById("hospitalName").value;
    const q = query(hospitalRef, where("name", "==", serchHospital ));
    const querySnapshot = await getDocs(q);
    console.log(querySnapshot);

    //当てはまる病院の受け入れ人数を更新
    querySnapshot.forEach(async (doc) => { 
      //ドキュメントIDと受け入れ人数を出力
      console.log(doc.id, " => ", doc.data());
      console.log(doc.data().numOfAccepted);
      
      //テキストボックスに入力された文字列を10進数に変換
      const numOfAcceptedIDValue = document.getElementById("numOfAcceptedID").value;
      const numOfAcceptedIDNumber = parseInt(numOfAcceptedIDValue, 10);

      //ドキュメントIDに対して受け入れ人数を更新
      const hospitalDocRef = doc.ref;
      await updateDoc(hospitalDocRef,{
        numOfAccepted: numOfAcceptedIDNumber
      });
      console.log("update numOfAccepted")
      });
  });
</script>
</body>
</html>